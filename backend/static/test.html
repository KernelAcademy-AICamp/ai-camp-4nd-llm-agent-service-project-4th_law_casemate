<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>판례 검색 테스트</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .search-box input {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
        }

        .search-box input:focus {
            border-color: #4a90d9;
        }

        .search-box button {
            padding: 15px 30px;
            font-size: 16px;
            background-color: #4a90d9;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .search-box button:hover {
            background-color: #357abd;
        }

        .search-box button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .results-info {
            margin-bottom: 20px;
            color: #666;
        }

        .result-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .result-score {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
        }
        .result-score.high {
            background: #d4edda;
            color: #155724;
        }
        .result-score.medium {
            background: #fff3cd;
            color: #856404;
        }
        .result-score.low {
            background: #e8f4fd;
            color: #4a90d9;
        }
        .highlight {
            background: #fff59d;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: 500;
        }

        .result-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .result-meta span {
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .result-content {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #444;
            white-space: pre-wrap;
            display: none;
            margin-top: 15px;
        }

        .result-content.expanded {
            display: block;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-detail {
            background: #4a90d9;
        }

        .btn-detail:hover {
            background: #357abd;
        }

        .btn-summary {
            background: #28a745;
        }

        .btn-summary:hover {
            background: #218838;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .summary-box {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .summary-box h4 {
            margin-bottom: 10px;
            color: #856404;
        }

        .summary-box p {
            color: #333;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>

<body>
    <h1>판례 검색 테스트</h1>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="검색어를 입력하세요 (예: 명예훼손, 모욕죄)" />
        <button id="searchBtn" onclick="search()">검색</button>
    </div>

    <div id="resultsInfo" class="results-info"></div>
    <div id="results"></div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let searchResults = []; // 검색 결과 저장
        let currentQuery = ''; // 현재 검색어 저장

        // 엔터키로 검색
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                search();
            }
        });

        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                alert('검색어를 입력하세요.');
                return;
            }

            currentQuery = query; // 검색어 저장

            const searchBtn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const resultsInfo = document.getElementById('resultsInfo');

            searchBtn.disabled = true;
            searchBtn.textContent = '검색 중...';
            resultsDiv.innerHTML = '<div class="loading">검색 중입니다...</div>';
            resultsInfo.innerHTML = '';

            try {
                const response = await fetch(
                    `${API_BASE}/api/search/cases?query=${encodeURIComponent(query)}&limit=30`
                );

                if (!response.ok) {
                    throw new Error('검색 중 오류가 발생했습니다.');
                }

                const data = await response.json();
                searchResults = data.results; // 결과 저장
                displayResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">${error.message}</div>`;
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = '검색';
            }
        }

        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const resultsInfo = document.getElementById('resultsInfo');

            resultsInfo.innerHTML = `검색어: <strong>"${data.query}"</strong> | 결과: <strong>${data.total}건</strong>`;

            if (data.results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">검색 결과가 없습니다.</div>';
                return;
            }

            let html = '';
            data.results.forEach((result, index) => {
                const rank = index + 1;
                let relevanceClass, relevanceText;
                if (rank <= 3) {
                    relevanceClass = 'high';
                    relevanceText = '관련도: 높음';
                } else if (rank <= 10) {
                    relevanceClass = 'medium';
                    relevanceText = '관련도: 중간';
                } else {
                    relevanceClass = 'low';
                    relevanceText = '관련도: 보통';
                }
                html += `
                    <div class="result-card" id="card-${index}">
                        <div class="result-header">
                            <div class="result-title">${result.case_name || '사건명 없음'}</div>
                            <div class="result-score ${relevanceClass}">${relevanceText}</div>
                        </div>
                        <div class="result-meta">
                            <span>${result.case_number}</span>
                            <span>${result.court_name}</span>
                            <span>${formatDate(result.judgment_date)}</span>
                        </div>
                        <div class="result-actions">
                            <button class="btn btn-detail" onclick="toggleDetail(${index})">
                                전문보기
                            </button>
                            <button class="btn btn-summary" onclick="summarize(${index})">
                                요약하기
                            </button>
                        </div>
                        <div class="result-content" id="content-${index}">${highlightKeywords(escapeHtml(result.content), currentQuery)}</div>
                        <div id="summary-${index}"></div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function toggleDetail(index) {
            const contentDiv = document.getElementById(`content-${index}`);
            const btn = event.target;

            if (contentDiv.classList.contains('expanded')) {
                contentDiv.classList.remove('expanded');
                btn.textContent = '전문보기';
            } else {
                contentDiv.classList.add('expanded');
                btn.textContent = '접기';
            }
        }

        async function summarize(index) {
            const summaryDiv = document.getElementById(`summary-${index}`);
            const btn = event.target;
            const content = searchResults[index].content;

            btn.disabled = true;
            btn.textContent = '요약 중...';
            summaryDiv.innerHTML = '<div class="loading">LLM이 요약 중입니다...</div>';

            try {
                const response = await fetch(`${API_BASE}/api/search/summarize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: content })
                });

                if (!response.ok) {
                    throw new Error('요약 중 오류가 발생했습니다.');
                }

                const data = await response.json();
                summaryDiv.innerHTML = `
                    <div class="summary-box">
                        <h4>AI 요약</h4>
                        <p>${escapeHtml(data.summary)}</p>
                    </div>
                `;
                btn.textContent = '요약 완료';
            } catch (error) {
                summaryDiv.innerHTML = `<div class="error">${error.message}</div>`;
                btn.disabled = false;
                btn.textContent = '요약하기';
            }
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8) return dateStr || '';
            return `${dateStr.slice(0, 4)}.${dateStr.slice(4, 6)}.${dateStr.slice(6, 8)}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function highlightKeywords(text, query) {
            if (!text || !query) return text;

            // 검색어를 공백으로 분리하여 각각 하이라이팅
            const keywords = query.split(/\s+/).filter(k => k.length > 0);

            let result = text;
            keywords.forEach(keyword => {
                // 대소문자 구분 없이 검색 (한글은 영향 없음)
                const regex = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                result = result.replace(regex, '<span class="highlight">$1</span>');
            });

            return result;
        }
    </script>
</body>

</html>